<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPSTORE | Premium Cloud</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&family=Syne:wght@800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAe9T7KzOB6jaau5hcPkeicO7GYa893kcQ",
            authDomain: "ipstore-pro.firebaseapp.com",
            projectId: "ipstore-pro",
            storageBucket: "ipstore-pro.firebasestorage.app",
            messagingSenderId: "500676115572",
            appId: "1:500676115572:web:5718176fc67d26ee0e6521"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.fb = { db, collection, onSnapshot, query, orderBy, addDoc, deleteDoc, doc };
    </script>

    <style>
        :root { --accent: #0071e3; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #fff; color: #1d1d1f; }
        .hero-title { font-family: 'Syne'; font-size: 4rem; font-weight: 800; text-align: center; margin-top: 50px; }
        #adminArea { display: none; background: #f5f5f7; border-radius: 20px; padding: 25px; margin: 30px 0; border: 1px solid #ddd; }
        .product-card { background: #f5f5f7; border-radius: 25px; padding: 20px; text-align: center; transition: 0.3s; height: 100%; }
        .product-card img { max-width: 100%; height: 250px; object-fit: contain; margin-bottom: 20px; }
        .btn-buy { background: #1d1d1f; color: #fff; border-radius: 50px; padding: 10px 25px; border: none; font-weight: 700; width: 100%; }
        
        /* New Payment UI */
        .qris-box { border: 2px dashed #ccc; border-radius: 15px; padding: 15px; text-align: center; background: #fff; }
        .bank-info { background: #0071e3; color: white; border-radius: 12px; padding: 15px; margin-top: 10px; }
    </style>
</head>
<body>

<nav class="navbar navbar-light bg-white border-bottom">
    <div class="container">
        <a class="navbar-brand fw-bold" href="#" style="font-family:'Syne'">IPSTORE</a>
        <button class="btn btn-sm btn-outline-dark rounded-circle" onclick="login()"><i class="fas fa-lock"></i> Admin</button>
    </div>
</nav>

<div class="container py-4">
    <h1 class="hero-title">Inovasi.<br>Tanpa Batas.</h1>
    <p class="text-center fw-bold text-muted">Authorized Cloud Experience 2026</p>

    <div id="adminArea">
        <h5 class="fw-bold mb-3">Inventory Control</h5>
        <form id="pForm">
            <div class="row g-2">
                <div class="col-md-3"><input type="text" id="n" class="form-control" placeholder="Nama Perangkat" required></div>
                <div class="col-md-2"><input type="number" id="h" class="form-control" placeholder="Harga" required></div>
                <div class="col-md-3"><input type="url" id="u" class="form-control" placeholder="Link Alamat Gambar" required></div>
                <div class="col-md-2"><select id="s" class="form-select"><option>Ready Stock</option><option>Sold Out</option></select></div>
                <div class="col-md-2"><button type="submit" id="btnS" class="btn btn-primary w-100">Simpan</button></div>
            </div>
        </form>
        <button onclick="logout()" class="btn btn-link btn-sm text-danger mt-2">Logout Admin</button>
    </div>

    <div class="row g-4 mt-2" id="catalog">
        <div class="col-12 text-center py-5" id="loader">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3 fw-bold">Menghubungkan ke Cloud...</p>
        </div>
    </div>
</div>

<div class="modal fade" id="checkoutModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 25px; border: none;">
            <div class="modal-body p-4">
                <div id="paymentStep">
                    <h4 class="fw-bold mb-3">Metode Pembayaran</h4>
                    <p class="text-muted small">Silakan pilih QRIS atau Transfer Bank untuk <b id="buyUnitName"></b></p>
                    
                    <div class="qris-box mb-3">
                        <span class="badge bg-light text-dark mb-2">QRIS IPSTORE</span><br>
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=IPSTORE-PAYMENT" width="150" alt="QRIS">
                    </div>

                    <div class="bank-info mb-4">
                        <small>TRANSFER BANK (BCA)</small>
                        <div class="h5 fw-bold m-0">8820-1234-5678</div>
                        <small>a/n IPSTORE PREMIUM RETAIL</small>
                    </div>

                    <label class="fw-bold small mb-2">Unggah Bukti Pembayaran:</label>
                    <input type="file" id="inputBukti" class="form-control mb-3" accept="image/*">
                    <button class="btn btn-primary w-100 rounded-pill fw-bold py-2" onclick="toAddressStep()">Konfirmasi & Lanjut</button>
                </div>

                <div id="addressStep" style="display: none;">
                    <h4 class="fw-bold mb-3">Detail Pengiriman</h4>
                    <p class="text-muted small">Lengkapi data untuk memproses pesanan Anda.</p>
                    <input type="text" id="custName" class="form-control mb-2" placeholder="Nama Penerima">
                    <input type="number" id="custWA" class="form-control mb-2" placeholder="No. WhatsApp Aktif">
                    <textarea id="custAddr" class="form-control mb-3" placeholder="Alamat Lengkap Pengiriman" rows="3"></textarea>
                    <button class="btn btn-success w-100 rounded-pill fw-bold py-2" onclick="processOrder()">Selesaikan Pesanan</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentItem = {};

    const checkFirebase = setInterval(() => {
        if (window.fb) {
            clearInterval(checkFirebase);
            initApp();
        }
    }, 500);

    function initApp() {
        const catalog = document.getElementById('catalog');
        const loader = document.getElementById('loader');

        const q = fb.query(fb.collection(fb.db, "items"), fb.orderBy("time", "desc"));
        
        fb.onSnapshot(q, (snapshot) => {
            loader.style.display = 'none';
            catalog.innerHTML = '';
            
            if (snapshot.empty) {
                catalog.innerHTML = '<div class="col-12 text-center py-5 text-muted">Katalog kosong.</div>';
                return;
            }

            snapshot.forEach((docSnap) => {
                const item = docSnap.data();
                const id = docSnap.id;
                const isAdmin = sessionStorage.getItem('isAdm');
                
                catalog.innerHTML += `
                    <div class="col-md-4">
                        <div class="product-card">
                            <img src="${item.img}" onerror="this.src='https://via.placeholder.com/300?text=Gambar+Error'">
                            <h5 class="fw-bold">${item.nama}</h5>
                            <p class="text-primary fw-bold">Rp ${parseInt(item.harga).toLocaleString('id-ID')}</p>
                            <span class="badge ${item.stok === 'Sold Out' ? 'bg-danger' : 'bg-success'} mb-3">${item.stok}</span>
                            ${isAdmin ? 
                                `<button onclick="delItem('${id}')" class="btn btn-danger btn-sm w-100 rounded-pill">Hapus</button>` : 
                                `<button class="btn btn-buy" onclick="checkout('${item.nama}', '${item.harga}')" ${item.stok === 'Sold Out' ? 'disabled' : ''}>Beli Sekarang</button>`
                            }
                        </div>
                    </div>`;
            });
        });

        document.getElementById('pForm').onsubmit = async (e) => {
            e.preventDefault();
            const b = document.getElementById('btnS');
            b.disabled = true; b.innerText = "Proses...";
            try {
                await fb.addDoc(fb.collection(fb.db, "items"), {
                    nama: document.getElementById('n').value,
                    harga: document.getElementById('h').value,
                    img: document.getElementById('u').value,
                    stok: document.getElementById('s').value,
                    time: Date.now()
                });
                document.getElementById('pForm').reset();
                Swal.fire('Berhasil!', 'Katalog diperbarui', 'success');
            } catch (err) { Swal.fire('Gagal', err.message, 'error'); }
            finally { b.disabled = false; b.innerText = "Simpan"; }
        };
    }

    // --- ALUR PEMBELIAN BARU ---
    window.checkout = (nama, harga) => {
        currentItem = { nama, harga };
        document.getElementById('buyUnitName').innerText = nama;
        document.getElementById('paymentStep').style.display = 'block';
        document.getElementById('addressStep').style.display = 'none';
        new bootstrap.Modal(document.getElementById('checkoutModal')).show();
    };

    window.toAddressStep = () => {
        const bukti = document.getElementById('inputBukti').files[0];
        if(!bukti) {
            Swal.fire('Peringatan', 'Harap unggah bukti transfer dahulu!', 'warning');
            return;
        }
        document.getElementById('paymentStep').style.display = 'none';
        document.getElementById('addressStep').style.display = 'block';
    };

    window.processOrder = async () => {
        const nama = document.getElementById('custName').value;
        const wa = document.getElementById('custWA').value;
        const alamat = document.getElementById('custAddr').value;

        if(!nama || !wa || !alamat) {
            Swal.fire('Data Tidak Lengkap', 'Mohon isi semua form pengiriman.', 'warning');
            return;
        }

        // Simpan ke database 'orders'
        try {
            await fb.addDoc(fb.collection(fb.db, "orders"), {
                unit: currentItem.nama,
                harga: currentItem.harga,
                customer: nama,
                whatsapp: wa,
                alamat: alamat,
                status: "Diproses",
                time: Date.now()
            });

            bootstrap.Modal.getInstance(document.getElementById('checkoutModal')).hide();
            
            Swal.fire({
                icon: 'success',
                title: 'Pesanan Berhasil!',
                text: 'Pesanan sedang diproses. Admin akan menghubungi Anda via WhatsApp.',
                confirmButtonColor: '#0071e3'
            }).then(() => location.reload());

        } catch (e) {
            Swal.fire('Error', 'Gagal memproses pesanan.', 'error');
        }
    };

    // --- AUTH ---
    window.login = () => {
        Swal.fire({ title: 'Admin Login', input: 'password' }).then(res => {
            if(res.value === 'admin123') {
                sessionStorage.setItem('isAdm', '1');
                location.reload();
            }
        });
    };
    window.logout = () => { sessionStorage.clear(); location.reload(); };
    window.delItem = async (id) => { if(confirm('Hapus?')) await fb.deleteDoc(fb.doc(fb.db, "items", id)); };

    if(sessionStorage.getItem('isAdm')) document.getElementById('adminArea').style.display = 'block';
</script>

</body>
</html>
