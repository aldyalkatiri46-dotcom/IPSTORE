<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IPSTORE | Exclusive Online Shop</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=Syne:wght@800&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAe9T7KzOB6jaau5hcPkeicO7GYa893kcQ",
            authDomain: "ipstore-pro.firebaseapp.com",
            projectId: "ipstore-pro",
            storageBucket: "ipstore-pro.firebasestorage.app",
            messagingSenderId: "500676115572",
            appId: "1:500676115572:web:5718176fc67d26ee0e6521"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.fb = { db, collection, onSnapshot, query, orderBy, addDoc, deleteDoc, doc, updateDoc };
    </script>

    <style>
        :root { --accent: #0071e3; --bg: #ffffff; --text: #1d1d1f; --card: #f5f5f7; --nav-bg: rgba(255, 255, 255, 0.8); }
        [data-theme="dark"] { --bg: #000000; --text: #f5f5f7; --card: #1c1c1e; --nav-bg: rgba(0, 0, 0, 0.8); }
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); transition: 0.5s; overflow-x: hidden; }
        .navbar { background: var(--nav-bg) !important; backdrop-filter: blur(20px); border-bottom: 1px solid rgba(128,128,128,0.2) !important; z-index: 1000; }
        .navbar-brand { display: flex; align-items: center; gap: 8px; font-size: 1.6rem !important; color: var(--text) !important; }

        .nav-custom-btn { border: 1px solid var(--accent) !important; color: var(--accent) !important; font-weight: 600; transition: 0.3s; }
        [data-theme="dark"] .nav-custom-btn { color: #f5f5f7 !important; border-color: rgba(255, 255, 255, 0.3) !important; }
        .nav-custom-btn:hover { background: var(--accent) !important; color: white !important; border-color: var(--accent) !important; }

        #heroSlider { margin-top: 85px; max-width: 950px; margin-left: auto; margin-right: auto; border-radius: 20px; overflow: hidden; box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .carousel-item img { width: 100%; height: auto; max-height: 450px; object-fit: cover; display: block; }
        
        .search-box input { width: 100%; padding: 12px 20px 12px 45px; border-radius: 50px; border: 1px solid rgba(128,128,128,0.2); background: var(--card); color: var(--text); outline: none; transition: 0.3s; }
        .cat-btn { border: none; background: var(--card); color: var(--text); padding: 8px 20px; border-radius: 50px; font-weight: 600; transition: 0.3s; white-space: nowrap; font-size: 0.9rem; border: 1px solid rgba(128,128,128,0.1); }
        .cat-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        .product-card { background: var(--card); border-radius: 25px; padding: 20px; text-align: center; transition: 0.4s; height: 100%; border: 1px solid rgba(128,128,128,0.1); position: relative; }
        .product-card img { width: 100%; height: 180px; object-fit: contain; margin-bottom: 15px; cursor: pointer; }
        
        .pay-card { cursor: pointer; border: 2px solid #eee; border-radius: 15px; padding: 15px 5px; transition: 0.3s; background: #fff; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 90px; }
        .pay-card i { font-size: 1.5rem; margin-bottom: 8px; color: var(--accent); }
        .pay-card span { font-size: 0.7rem; font-weight: 800; color: #333; text-transform: uppercase; }

        .wa-float-btn { position: absolute; top: 15px; right: 15px; background: #25d366; color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; text-decoration: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 5; border: none; }
        
        .btn-action-group { display: flex; gap: 8px; margin-top: 10px; }
        .btn-cart { background: #e3f2fd; color: var(--accent); border-radius: 50px; padding: 10px; border: none; font-weight: 700; flex: 1; transition: 0.3s; }
        .btn-buy { background: var(--accent); color: #fff; border-radius: 50px; padding: 10px; border: none; font-weight: 700; flex: 2; transition: 0.3s; }

        .help-btn { position: fixed; bottom: 20px; right: 20px; background: #ff3b30; color: white; border-radius: 50px; padding: 10px 20px; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 999; border: none; display: flex; align-items: center; gap: 8px;}
        .cart-float { position: fixed; bottom: 80px; right: 20px; background: var(--accent); color: white; width: 55px; height: 55px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; box-shadow: 0 5px 20px rgba(0,113,227,0.4); z-index: 998; border: none; }
        .cart-badge { position: absolute; top: -5px; right: -5px; background: #ff3b30; color: white; font-size: 0.7rem; padding: 3px 7px; border-radius: 50%; font-weight: 800; border: 2px solid white; }

        #adminArea { display: none; background: var(--card); border-radius: 20px; padding: 25px; margin: 25px 0; border: 1px solid var(--accent); }
        .price-old { text-decoration: line-through; color: #888; font-size: 0.85rem; margin-right: 5px; }
        .badge-stok { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.6); color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; z-index: 5; }
        .rating-stars { color: #ffcc00; font-size: 0.8rem; margin-bottom: 5px; }

        @media (max-width: 768px) {
            #heroSlider { margin-top: 80px; width: 95%; border-radius: 15px; }
            .carousel-item img { max-height: 200px; }
            .category-nav { justify-content: flex-start !important; overflow-x: auto; padding: 10px 5px; gap: 8px !important; }
            .cat-btn { padding: 6px 12px; font-size: 0.75rem; flex-shrink: 0; }
            .product-card img { height: 110px; }
        }
    </style>
</head>
<body data-theme="light">

<nav class="navbar navbar-expand-lg fixed-top">
    <div class="container">
        <a class="navbar-brand fw-bold" href="#"><i class="fab fa-apple"></i> <span style="color: var(--accent);">IPSTORE</span></a>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm nav-custom-btn rounded-pill px-3" onclick="showAbout()">Tentang</button>
            <div class="theme-toggle ms-2" onclick="toggleTheme()" id="themeIcon" style="cursor:pointer;"><i class="fas fa-moon"></i></div>
            <button class="btn btn-sm btn-dark rounded-pill px-3 ms-2" onclick="login()">Admin</button>
        </div>
    </div>
</nav>

<button class="cart-float" onclick="openCart()">
    <i class="fas fa-shopping-bag"></i>
    <span class="cart-badge" id="cartBadge">0</span>
</button>

<button class="help-btn" onclick="askHelp()"><i class="fas fa-headset"></i> Bantuan & Lacak</button>

<div class="container">
    <div id="heroSlider" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-indicators" id="sliderIndicators"></div>
        <div class="carousel-inner" id="sliderContent">
            <div class="carousel-item active"><div class="d-flex align-items-center justify-content-center h-100 p-5">Memuat Promo...</div></div>
        </div>
    </div>

    <h1 class="hero-title mt-5 text-center fw-bold" style="font-family:'Syne'; font-size: 2.5rem;">Berbagai Produk Apple</h1>
    <p class="text-center fw-bold opacity-50 mb-4">Official IPSTORE</p>

    <div class="search-wrapper mb-4 text-center">
        <div class="search-box d-inline-block w-100" style="max-width: 600px; position: relative;">
            <i class="fas fa-search" style="position: absolute; left: 18px; top: 15px; opacity: 0.5;"></i>
            <input type="text" id="searchInput" placeholder="Cari iPhone, iPad, atau Watch..." onkeyup="handleSearch()" class="form-control shadow-sm">
        </div>
    </div>

    <div class="category-nav d-flex justify-content-center gap-2 mb-4">
        <button class="cat-btn active" onclick="filterCat('All', this)">Semua Produk</button>
        <button class="cat-btn" onclick="filterCat('iPhone', this)">iPhone</button>
        <button class="cat-btn" onclick="filterCat('iPad', this)">iPad</button>
        <button class="cat-btn" onclick="filterCat('Watch', this)">Smartwatch</button>
    </div>

    <div id="adminArea">
        <h5 class="fw-bold mb-3" id="adminTitle">Dashboard Admin</h5>
        <form id="pForm" class="mb-4">
            <div class="row g-2">
                <div class="col-md-3"><input type="text" id="n" class="form-control" placeholder="Nama Produk" required></div>
                <div class="col-md-2"><input type="number" id="h" class="form-control" placeholder="Harga Jual" required></div>
                <div class="col-md-2"><input type="number" id="hc" class="form-control" placeholder="Harga Coret (Opsional)"></div>
                <div class="col-md-2"><input type="number" id="stok" class="form-control" placeholder="Stok" value="10"></div>
                <div class="col-md-3"><input type="url" id="u" class="form-control" placeholder="Link Gambar" required></div>
                <div class="col-md-2"><select id="cat" class="form-select"><option>iPhone</option><option>iPad</option><option>Watch</option></select></div>
                <div class="col-md-4"><input type="text" id="variants" class="form-control" placeholder="Varian (Pisah koma: Black, Blue)"></div>
                <div class="col-12 mt-2"><textarea id="desc" class="form-control" placeholder="Deskripsi Produk (Tuliskan Detail Spesifikasi di Sini)"></textarea></div>
                <div class="col-md-2 mt-2">
                    <button type="submit" id="btnSubmitAdmin" class="btn btn-primary w-100">Tambah Produk</button>
                </div>
                <div class="col-md-2 mt-2" id="cancelEditArea" style="display:none">
                    <button type="button" onclick="cancelEdit()" class="btn btn-secondary w-100">Batal</button>
                </div>
            </div>
        </form>
        <hr>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="fw-bold">Manajemen Banner</h6>
            <button class="btn btn-sm btn-outline-primary" onclick="viewOrders()">Lihat Riwayat Pesanan DB</button>
        </div>
        <form id="bannerForm">
            <div class="row g-2">
                <div class="col-md-10"><input type="url" id="bannerUrl" class="form-control" placeholder="Link Banner Baru" required></div>
                <div class="col-md-2"><button type="submit" class="btn btn-warning w-100">Add Banner</button></div>
            </div>
        </form>
        <button onclick="logout()" class="btn btn-sm btn-link text-danger mt-2 text-decoration-none">Keluar Admin</button>
    </div>

    <div class="row g-3 g-md-4" id="catalog">
        <div class="col-12 text-center py-5" id="loader"><div class="spinner-grow text-primary"></div></div>
    </div>
</div>

<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg bg-white text-dark">
            <div class="modal-header border-0 pb-0"><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body p-4 pt-0">
                <div class="text-center mb-3"><img id="detailImg" src="" style="max-height: 200px; object-fit: contain;"></div>
                <h4 id="detailNama" class="fw-bold mb-1"></h4>
                <div class="rating-stars mb-2"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i> <span class="text-muted small">(4.9/5)</span></div>
                <div class="d-flex align-items-center mb-3">
                    <span id="detailHargaCoret" class="price-old fs-5" style="display:none"></span>
                    <h5 id="detailHarga" class="text-primary fw-bold mb-0"></h5>
                </div>
                <div id="variantArea" class="mb-3">
                    <p class="fw-bold small mb-1">Pilih Varian:</p>
                    <div id="variantList" class="d-flex gap-2 flex-wrap"></div>
                </div>
                <hr>
                <p class="fw-bold small mb-1">Deskripsi:</p>
                <p id="detailDesc" class="text-muted small mb-4" style="white-space: pre-line;"></p>
                <div class="d-flex gap-2">
                    <button id="detailBtnCart" class="btn btn-light flex-grow-1 fw-bold rounded-pill border">Keranjang</button>
                    <button id="detailBtnBuy" class="btn btn-primary flex-grow-1 fw-bold rounded-pill" style="flex: 2;">Beli Sekarang</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="cartModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 bg-light text-dark"><h5 class="modal-title fw-bold">Keranjang Saya</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div id="cartList" style="max-height: 300px; overflow-y: auto;"></div>
                <hr><div class="d-flex justify-content-between fw-bold mb-3 text-dark"><span>Total:</span><span class="text-primary" id="cartTotalDisplay">Rp 0</span></div>
                <button class="btn btn-primary w-100 rounded-pill py-2 fw-bold" onclick="startCheckout('multi')" id="btnMultiCheckout">CHECKOUT SEMUA</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="checkoutModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content shadow-lg border-0 bg-white"><div class="modal-body p-4 text-center text-dark">
            <div id="stepAddress">
                <h5 class="fw-bold mb-3">Biodata Pengiriman</h5>
                <input type="text" id="custName" class="form-control mb-2" placeholder="Nama Lengkap">
                <input type="number" id="custWA" class="form-control mb-2" placeholder="No WhatsApp Aktif">
                <textarea id="custAddr" class="form-control mb-3" placeholder="Alamat Lengkap"></textarea>
                <button class="btn btn-primary w-100 rounded-pill py-2 fw-bold" onclick="toMethodStep()">LANJUT PILIH PEMBAYARAN</button>
            </div>
            <div id="stepMethod" style="display: none;">
                <h4 class="fw-bold mb-4">Pilih Metode Pembayaran</h4>
                <div class="row g-2">
                    <div class="col-4"><div class="pay-card" onclick="selectPay('Bank Mandiri')"><i class="fas fa-university"></i><span>MANDIRI</span></div></div>
                    <div class="col-4"><div class="pay-card" onclick="selectPay('Bank BCA')"><i class="fas fa-university"></i><span>BCA</span></div></div>
                    <div class="col-4"><div class="pay-card" onclick="selectPay('QRIS')"><i class="fas fa-qrcode"></i><span>QRIS</span></div></div>
                    <div class="col-4"><div class="pay-card" onclick="selectPay('COD')"><i class="fas fa-truck"></i><span>COD</span></div></div>
                </div>
                <button class="btn btn-link btn-sm mt-3 text-decoration-none" onclick="backToAddress()">Kembali</button>
            </div>
            <div id="stepTransfer" style="display: none;">
                <h5 class="fw-bold mb-3">Konfirmasi</h5>
                <div class="alert alert-info text-start small">Bank: <b>Mandiri</b><br>A/N: <b>Ali Rahmat Alkatiri</b><br>No Rek: <b>123-456-7890</b></div>
                <p class="small text-muted mb-3">Upload bukti pembayaran untuk mempercepat proses.</p>
                <input type="file" id="inputBukti" class="form-control mb-3" accept="image/*">
                <button class="btn btn-success w-100 rounded-pill py-2 fw-bold" onclick="processOrder()">KONFIRMASI & KIRIM</button>
            </div>
        </div></div>
    </div>
</div>

<div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow"><div class="modal-header border-0 bg-light text-dark"><h5 class="modal-title fw-bold">Pusat Bantuan</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body p-4"><div id="helpMenu">
                <button class="btn btn-outline-primary w-100 mb-3 p-3 text-start fw-bold" onclick="showHelpDetail('Tanya Produk')"><i class="fas fa-info-circle me-2"></i> Tanya Detail Produk</button>
                <button class="btn btn-outline-success w-100 mb-3 p-3 text-start fw-bold" onclick="openTracking()"><i class="fas fa-truck-fast me-2"></i> Lacak Resi (CekResi.com)</button>
                <button class="btn btn-outline-danger w-100 mb-3 p-3 text-start fw-bold" onclick="showHelpDetail('Lacak Pesanan')"><i class="fas fa-headset me-2"></i> Lacak Pesanan via Admin</button>
            </div>
            <div id="helpFormDetail" style="display: none;" class="text-dark">
                <h6 id="helpTitle" class="fw-bold text-primary mb-3"></h6>
                <input type="text" id="helpName" class="form-control mb-2" placeholder="Nama"><textarea id="helpProblem" class="form-control mb-3" placeholder="Masalah..."></textarea>
                <button class="btn btn-primary w-100 rounded-pill" onclick="sendHelpWA()">Kirim</button><button class="btn btn-link btn-sm w-100" onclick="backHelp()">Kembali</button>
            </div></div>
        </div>
    </div>
</div>

<footer class="mt-5 py-4 text-center opacity-70 border-top"><p class="mb-0">&copy; 2026 IPSTORE. All Rights Reserved.</p></footer>

<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>
    AOS.init();
    const MY_WA = "6282150978972";
    let allItems = [], currentFilter = 'All', currentItem = {}, selectedMethod = "", helpType = "", checkoutMode = "single", editId = null;
    let selectedVariant = "";
    let cart = JSON.parse(localStorage.getItem('ipstore_cart')) || [];

    function updateCartUI() {
        localStorage.setItem('ipstore_cart', JSON.stringify(cart));
        const badge = document.getElementById('cartBadge');
        badge.innerText = cart.reduce((acc, item) => acc + item.qty, 0);
        const list = document.getElementById('cartList'), totalDisp = document.getElementById('cartTotalDisplay'), btnAll = document.getElementById('btnMultiCheckout');
        if(cart.length === 0) { list.innerHTML = '<p class="text-center py-4 opacity-50">Keranjang kosong</p>'; totalDisp.innerText = 'Rp 0'; btnAll.disabled = true; return; }
        btnAll.disabled = false; let html = '', total = 0;
        cart.forEach((item, idx) => {
            const sub = item.harga * item.qty; total += sub;
            html += `<div class="d-flex align-items-center mb-2 border-bottom pb-2 text-dark"><img src="${item.img}" style="width:40px; height:40px; object-fit:contain;" class="me-2"><div class="flex-grow-1"><div class="fw-bold small">${item.nama} ${item.variant ? '('+item.variant+')' : ''}</div><div class="text-primary small">Rp ${sub.toLocaleString()}</div></div>
                <div class="d-flex align-items-center gap-1"><button class="btn btn-sm btn-light border p-1" onclick="updateQty(${idx}, -1)">-</button><span class="small">${item.qty}</span><button class="btn btn-sm btn-light border p-1" onclick="updateQty(${idx}, 1)">+</button></div></div>`;
        });
        list.innerHTML = html; totalDisp.innerText = `Rp ${total.toLocaleString()}`;
    }

    function addToCart(nama, harga, img, variant = "") {
        const itemKey = nama + variant;
        const idx = cart.findIndex(i => (i.nama + (i.variant || "")) === itemKey);
        if(idx > -1) cart[idx].qty += 1; else cart.push({nama, harga: parseInt(harga), img, qty: 1, variant});
        updateCartUI(); Swal.fire({ icon: 'success', title: 'Berhasil!', toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
    }

    function updateQty(idx, delta) { cart[idx].qty += delta; if(cart[idx].qty <= 0) cart.splice(idx, 1); updateCartUI(); }
    function openCart() { new bootstrap.Modal('#cartModal').show(); }

    window.startCheckout = (mode, name, price, variant = "") => {
        checkoutMode = mode; 
        if(mode === 'single') currentItem = {nama: name, harga: price, variant: variant};
        document.getElementById('stepAddress').style.display = 'block'; document.getElementById('stepMethod').style.display = 'none'; document.getElementById('stepTransfer').style.display = 'none';
        if(mode === 'multi') bootstrap.Modal.getInstance(document.getElementById('cartModal')).hide();
        new bootstrap.Modal('#checkoutModal').show();
    };

    window.toMethodStep = () => { if(!document.getElementById('custName').value || !document.getElementById('custWA').value) return Swal.fire('Error','Lengkapi data!','error'); document.getElementById('stepAddress').style.display = 'none'; document.getElementById('stepMethod').style.display = 'block'; };
    window.backToAddress = () => { document.getElementById('stepAddress').style.display = 'block'; document.getElementById('stepMethod').style.display = 'none'; };
    window.selectPay = (m) => { selectedMethod = m; document.getElementById('stepMethod').style.display = 'none'; if(m === 'COD') processOrder(); else document.getElementById('stepTransfer').style.display = 'block'; };

    window.processOrder = async () => {
        const n = document.getElementById('custName').value, w = document.getElementById('custWA').value, a = document.getElementById('custAddr').value;
        let total = 0, detail = "";
        
        const orderItems = [];
        if(checkoutMode === 'single') { 
            total = currentItem.harga; 
            detail = `- ${currentItem.nama} ${currentItem.variant ? '('+currentItem.variant+')' : ''} (1x)`; 
            orderItems.push(currentItem);
        } else { 
            cart.forEach(i => { total += (i.harga * i.qty); detail += `- ${i.nama} ${i.variant ? '('+i.variant+')' : ''} (${i.qty}x)\n`; orderItems.push(i); }); 
        }

        // SIMPAN KE FIREBASE SEBAGAI DATABASE PESANAN (REKAP ADMIN)
        try {
            await fb.addDoc(fb.collection(fb.db, "orders"), {
                customer: n, whatsapp: w, address: a, items: orderItems, total: total, method: selectedMethod, time: Date.now()
            });
        } catch(e) { console.error("Error saving order:", e); }

        Swal.fire({ title: 'Memproses...', icon: 'info', timer: 2000, showConfirmButton: false, didOpen: () => { Swal.showLoading(); } }).then(() => {
            const text = encodeURIComponent(`PESANAN BARU!\n\nNama: ${n}\nWA: ${w}\nAlamat: ${a}\n\nPESANAN:\n${detail}\nTOTAL: Rp ${total.toLocaleString()}\nMETODE: ${selectedMethod}`);
            window.open(`https://wa.me/${MY_WA}?text=${text}`, '_blank'); 
            if(checkoutMode === 'multi') { cart = []; updateCartUI(); } 
            location.reload();
        });
    };

    window.showDetail = (id) => {
        const item = allItems.find(i => i.id === id); if(!item) return;
        selectedVariant = "";
        document.getElementById('detailImg').src = item.img; 
        document.getElementById('detailNama').innerText = item.nama; 
        document.getElementById('detailHarga').innerText = `Rp ${parseInt(item.harga).toLocaleString()}`;
        
        const hCoret = document.getElementById('detailHargaCoret');
        if(item.harga_coret) {
            hCoret.innerText = `Rp ${parseInt(item.harga_coret).toLocaleString()}`;
            hCoret.style.display = 'inline';
        } else { hCoret.style.display = 'none'; }

        // Varian Logic
        const vArea = document.getElementById('variantArea'), vList = document.getElementById('variantList');
        vList.innerHTML = "";
        if(item.variants && item.variants.length > 0) {
            vArea.style.display = 'block';
            item.variants.split(',').forEach(v => {
                const btn = document.createElement('button');
                btn.className = "btn btn-sm btn-outline-dark rounded-pill px-3 variant-opt";
                btn.innerText = v.trim();
                btn.onclick = () => {
                    document.querySelectorAll('.variant-opt').forEach(b => b.classList.replace('btn-dark','btn-outline-dark'));
                    btn.classList.replace('btn-outline-dark','btn-dark');
                    selectedVariant = v.trim();
                };
                vList.appendChild(btn);
            });
        } else { vArea.style.display = 'none'; }

        document.getElementById('detailDesc').innerText = item.deskripsi || "Produk Apple Original. Segel Box & Garansi Resmi.";
        document.getElementById('detailBtnCart').onclick = () => { addToCart(item.nama, item.harga, item.img, selectedVariant); bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide(); };
        document.getElementById('detailBtnBuy').onclick = () => { bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide(); startCheckout('single', item.nama, item.harga, selectedVariant); };
        new bootstrap.Modal('#detailModal').show();
    };

    window.editItem = (id) => {
        const item = allItems.find(i => i.id === id); if(!item) return;
        editId = id;
        document.getElementById('n').value = item.nama;
        document.getElementById('h').value = item.harga;
        document.getElementById('hc').value = item.harga_coret || '';
        document.getElementById('stok').value = item.stok || 0;
        document.getElementById('u').value = item.img;
        document.getElementById('cat').value = item.kategori || 'iPhone';
        document.getElementById('variants').value = item.variants || '';
        document.getElementById('desc').value = item.deskripsi || '';
        document.getElementById('adminTitle').innerText = "Edit Produk: " + item.nama;
        document.getElementById('btnSubmitAdmin').innerText = "Simpan Perubahan";
        document.getElementById('btnSubmitAdmin').classList.replace('btn-primary', 'btn-success');
        document.getElementById('cancelEditArea').style.display = 'block';
        window.scrollTo({top: document.getElementById('adminArea').offsetTop - 100, behavior: 'smooth'});
    };

    window.cancelEdit = () => {
        editId = null; document.getElementById('pForm').reset();
        document.getElementById('adminTitle').innerText = "Dashboard Admin";
        document.getElementById('btnSubmitAdmin').innerText = "Tambah Produk";
        document.getElementById('btnSubmitAdmin').classList.replace('btn-success', 'btn-primary');
        document.getElementById('cancelEditArea').style.display = 'none';
    };

    function renderCatalog() {
        const catalog = document.getElementById('catalog'); catalog.innerHTML = '';
        const term = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allItems.filter(i => i.nama.toLowerCase().includes(term) && (currentFilter === 'All' || i.kategori === currentFilter));
        filtered.forEach(item => {
            const stokHtml = item.stok <= 0 ? `<span class="badge-stok bg-danger">Habis</span>` : `<span class="badge-stok">Stok: ${item.stok}</span>`;
            catalog.innerHTML += `<div class="col-md-4 col-6" data-aos="fade-up">
                <div class="product-card">
                    ${stokHtml}
                    <button onclick="window.open('https://wa.me/${MY_WA}?text=Tanya%20${item.nama}','_blank')" class="wa-float-btn"><i class="fab fa-whatsapp"></i></button>
                    <img src="${item.img}" onclick="showDetail('${item.id}')">
                    <div class="rating-stars"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i></div>
                    <h6 class="fw-bold mb-1" onclick="showDetail('${item.id}')" style="cursor:pointer">${item.nama}</h6>
                    <div class="d-flex justify-content-center align-items-center mb-2">
                        ${item.harga_coret ? `<span class="price-old">Rp ${parseInt(item.harga_coret).toLocaleString()}</span>` : ''}
                        <p class="text-primary fw-bold mb-0">Rp ${parseInt(item.harga).toLocaleString()}</p>
                    </div>
                    ${sessionStorage.getItem('isAdm') ? 
                    `<div class="d-flex gap-1">
                        <button onclick="editItem('${item.id}')" class="btn btn-warning btn-sm flex-grow-1 text-white fw-bold">Edit</button>
                        <button onclick="delItem('${item.id}')" class="btn btn-danger btn-sm"><i class="fas fa-trash"></i></button>
                    </div>` : 
                    `<div class="btn-action-group">
                        <button class="btn-cart" ${item.stok <= 0 ? 'disabled' : ''} onclick="addToCart('${item.nama}', '${item.harga}', '${item.img}')"><i class="fas fa-cart-plus"></i></button>
                        <button class="btn-buy" ${item.stok <= 0 ? 'disabled' : ''} onclick="startCheckout('single', '${item.nama}', '${item.harga}')">${item.stok <= 0 ? 'Habis' : 'Beli'}</button>
                    </div>`}
                </div></div>`;
        });
    }

    function showAbout() { 
        Swal.fire({ 
            title: 'Tentang IPSTORE', 
            html: `
                <div class="text-start small">
                    <p class="mb-2"><strong>CEO:</strong> Ali Rahmat Alkatiri</p>
                    <p class="mb-2">Gadget Apple Terpercaya Sejak 2020.</p>
                    <hr>
                    <p class="text-danger fw-bold mb-1"><i class="fas fa-gavel"></i> PERINGATAN HUKUM:</p>
                    <p style="font-size: 0.75rem; line-height: 1.4;">
                        Berdasarkan <strong>UU Cipta Kerja</strong> dan <strong>UU Hak Cipta</strong>, segala bentuk duplikasi, tiruan, atau penggandaan konten, desain, dan sistem IPSTORE tanpa izin tertulis adalah pelanggaran hukum. 
                        Pelaku dapat dikenakan <strong>sanksi pidana</strong> penjara dan denda sesuai ketentuan hukum yang berlaku di Republik Indonesia.
                    </p>
                </div>
            `, 
            confirmButtonColor: '#0071e3',
            confirmButtonText: 'Saya Mengerti'
        }); 
    }
    function askHelp() { new bootstrap.Modal('#helpModal').show(); }
    function showHelpDetail(t) { helpType = t; document.getElementById('helpTitle').innerText = t; document.getElementById('helpMenu').style.display = 'none'; document.getElementById('helpFormDetail').style.display = 'block'; }
    function backHelp() { document.getElementById('helpMenu').style.display = 'block'; document.getElementById('helpFormDetail').style.display = 'none'; }
    function sendHelpWA() { window.open(`https://wa.me/${MY_WA}?text=BANTUAN: ${helpType}\nNama: ${document.getElementById('helpName').value}`, '_blank'); }
    function toggleTheme() { const b = document.body; const dark = b.getAttribute('data-theme') === 'dark'; b.setAttribute('data-theme', dark ? 'light' : 'dark'); document.getElementById('themeIcon').innerHTML = dark ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun text-warning"></i>'; }
    
    window.openTracking = () => {
        Swal.fire({ title: 'Lacak Resi', text: 'Buka cekresi.com untuk melacak pengiriman?', icon: 'info', showCancelButton: true, confirmButtonText: 'Buka', cancelButtonText: 'Batal' }).then((res) => { if(res.isConfirmed) window.open('https://cekresi.com', '_blank'); });
    }

    window.viewOrders = () => {
        Swal.fire('Fitur Rekap', 'Data pesanan telah tersimpan otomatis di koleksi "orders" Firebase Firestore.', 'info');
    }

    function initApp() {
        fb.onSnapshot(fb.query(fb.collection(fb.db, "banners"), fb.orderBy("time", "asc")), (snaps) => {
            const sc = document.getElementById('sliderContent'), si = document.getElementById('sliderIndicators'); sc.innerHTML = ''; si.innerHTML = ''; let i = 0;
            snaps.forEach(d => { sc.innerHTML += `<div class="carousel-item ${i===0?'active':''}"><img src="${d.data().url}"></div>`; si.innerHTML += `<button type="button" data-bs-target="#heroSlider" data-bs-slide-to="${i}" class="${i===0?'active':''}"></button>`; i++; });
        });
        fb.onSnapshot(fb.query(fb.collection(fb.db, "items"), fb.orderBy("time", "desc")), (snaps) => {
            document.getElementById('loader').style.display = 'none'; allItems = []; snaps.forEach(d => allItems.push({id: d.id, ...d.data()})); renderCatalog();
        });
        if(sessionStorage.getItem('isAdm')) document.getElementById('adminArea').style.display = 'block';
        updateCartUI();
    }

    window.handleSearch = () => renderCatalog();
    window.filterCat = (cat, btn) => { currentFilter = cat; document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderCatalog(); };
    window.login = () => { Swal.fire({title:'Admin', input:'password'}).then(r => { if(r.value==='admin123'){sessionStorage.setItem('isAdm','1');location.reload();} }); };
    window.logout = () => { sessionStorage.clear(); location.reload(); };
    window.delItem = async (id) => { if(confirm('Hapus produk ini?')) await fb.deleteDoc(fb.doc(fb.db,"items",id)); };
    
    document.getElementById('pForm').onsubmit = async (e) => {
        e.preventDefault();
        const data = { 
            nama: document.getElementById('n').value, 
            harga: document.getElementById('h').value, 
            harga_coret: document.getElementById('hc').value,
            stok: document.getElementById('stok').value,
            img: document.getElementById('u').value, 
            kategori: document.getElementById('cat').value, 
            variants: document.getElementById('variants').value,
            deskripsi: document.getElementById('desc').value, 
            time: Date.now() 
        };
        if(editId) await fb.deleteDoc(fb.doc(fb.db, "items", editId)); 
        await fb.addDoc(fb.collection(fb.db, "items"), data);
        location.reload();
    };

    document.getElementById('bannerForm').onsubmit = async (e) => { e.preventDefault(); await fb.addDoc(fb.collection(fb.db, "banners"), { url: document.getElementById('bannerUrl').value, time: Date.now() }); location.reload(); };
    const checkFB = setInterval(() => { if (window.fb) { clearInterval(checkFB); initApp(); } }, 500);
</script>
</body>
</html>
